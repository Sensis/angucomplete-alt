/*! Copyright (c) 2014 Hidenari Nozaki and contributors | Licensed under the MIT license */
"use strict";!function(a,b){a.angular?b(a.angular):"undefined"!=typeof module&&module.exports?module.exports=b(require("angular")):"function"==typeof define&&define.amd&&define(["angular"],b)}(window,function(a){a.module("angucomplete-alt",[]).directive("angucompleteAlt",["$q","$compile","$parse","$http","$sce","$timeout","$templateCache","$interpolate",function(b,c,d,e,f,g,h,i){function j(d,h,i,j){function z(a,b){a&&("object"==typeof a?(d.searchStr=F(a),C({originalObject:a})):"string"==typeof a&&a.length>0?d.searchStr=a:console&&console.error&&console.error("Tried to set "+(b?"initial":"")+" value of angucomplete to",a,"which is an invalid value"),I(!0))}function A(a){wa=null,d.hideResults(a),document.body.removeEventListener("click",A)}function B(a){return a.which?a.which:a.keyCode}function C(a){"function"==typeof d.selectedObject?d.selectedObject(a):d.selectedObject=a,I(a?!0:!1)}function D(a){return function(b){return d[a]?d[a](b):b}}function E(a){C({originalObject:a}),d.clearSelected&&(d.searchStr=null),_()}function F(a){return d.titleField.split(",").map(function(b){return G(a,b)}).join(" ")}function G(a,b){var c,d;if(b){c=b.split("."),d=a;for(var e=0;e<c.length;e++)d=d[c[e]]}else d=a;return d}function H(a,b){var c,e,g;if(g=new RegExp(b.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"i"),a)return a.match&&a.replace||(a=a.toString()),e=a.match(g),c=e&&b.length>d.minLengthForMatchClass?a.replace(g,'<span class="'+d.matchClass+'">'+e[0]+"</span>"):a,f.trustAsHtml(c)}function I(a){d.notEmpty=a,sa=d.searchStr,d.fieldRequired&&j&&j.$setValidity(ra,a)}function J(a){var b=B(a);if(b!==n&&b!==l)if(b===m||b===p)a.preventDefault();else if(b===k)a.preventDefault(),!d.showDropdown&&d.searchStr&&d.searchStr.length>=d.minLengthForApiCall&&(aa(),d.searching=!0,ea(d.searchStr));else if(b===o)_(),d.$apply(function(){oa.val(d.searchStr),oa.trigger("change")});else{if("0"===d.minLengthForApiCall&&!d.searchStr)return;d.searchStr&&""!==d.searchStr?d.searchStr.length>=d.minLengthForApiCall&&da():d.showDropdown=!1,sa&&sa!==d.searchStr&&!d.clearSelected&&d.$apply(function(){C()})}}function K(a){!d.overrideSuggestions||d.selectedObject&&d.selectedObject.originalObject===d.searchStr||(a&&a.preventDefault(),g.cancel(qa),Y(),E(d.searchStr))}function L(a){var b=getComputedStyle(a);return a.offsetHeight+parseInt(b.marginTop,10)+parseInt(b.marginBottom,10)}function M(){return ua.getBoundingClientRect().top+parseInt(getComputedStyle(ua).maxHeight,10)}function N(){return h[0].querySelectorAll(".angucomplete-row")[d.currentIndex]}function O(){return N().getBoundingClientRect().top-(ua.getBoundingClientRect().top+parseInt(getComputedStyle(ua).paddingTop,10))}function P(a){ua.scrollTop=ua.scrollTop+a}function Q(){var a=d.results[d.currentIndex];R(d.matchClass?T()?"":F(a.originalObject):a.title)}function R(a){""===a?oa.val(a):oa.val(" "),g(function(){oa.val(a)},v)}function S(){T()||d.selectResult(d.results[d.currentIndex])}function T(){return F(d.results[d.currentIndex].originalObject)===d.clearListCustomLabel}function U(a){var b=B(a),c=null,e=null,f=!1;b===p&&d.results?(d.currentIndex>=0&&d.currentIndex<d.results.length?(a.preventDefault(),f=T(),S()):(K(a),_()),d.$apply(),f?(_(),d.$emit("angucomplete_on_clear_list")):d.$emit("angucomplete_key_en")):b===k&&d.results&&d.results.length>0?(a.preventDefault(),d.currentIndex+1<d.results.length&&d.showDropdown?(d.$apply(function(){d.currentIndex++,Q()}),va&&(c=N(),M()<c.getBoundingClientRect().bottom&&P(L(c)))):d.currentIndex+1===d.results.length&&d.showDropdown&&V()):b===m&&d.results&&d.results.length>0?(a.preventDefault(),d.currentIndex>=1?(d.$apply(function(){d.currentIndex--,Q()}),va&&(e=O(),e<0&&P(e-1))):0===d.currentIndex?V():d.currentIndex===-1&&d.$apply(function(){d.currentIndex=d.results.length-1,Q()})):b===q?d.results&&d.results.length>0&&d.showDropdown?d.currentIndex===-1&&d.overrideSuggestions?K():(d.currentIndex===-1&&(d.currentIndex=0),S(),d.$digest()):d.searchStr&&d.searchStr.length>0&&K():b===o&&a.preventDefault()}function V(){d.$apply(function(){d.currentIndex=-1,R(d.searchStr)})}function W(a){return function(b,c,e,f){c||e||f||(b=b.data),d.searching=!1,fa(G(ia(b),d.remoteUrlDataField),a)}}function X(a,b,c,e){0!==b&&b!==-1&&(b||c||e||(b=a.status),d.remoteUrlErrorCallback?d.remoteUrlErrorCallback(a,b,c,e):console&&console.error&&console.error("http error"))}function Y(){ta&&ta.resolve()}function Z(a){var c={},f=d.remoteUrl+encodeURIComponent(a);d.remoteUrlRequestFormatter&&(c={params:d.remoteUrlRequestFormatter(a)},f=d.remoteUrl),d.remoteUrlRequestWithCredentials&&(c.withCredentials=!0),Y(),ta=b.defer(),c.timeout=ta.promise,e.get(f,c).success(W(a)).error(X)}function $(a){Y(),ta=b.defer(),d.remoteApiHandler(a,ta.promise).then(W(a)).catch(X)}function _(){d.showDropdown=!1,d.results=[],ua&&(ua.scrollTop=0)}function aa(){d.showDropdown=ka,d.currentIndex=d.focusFirst?0:-1}function ba(a){var b,c,e,f,g=d.searchFields.split(","),h=[];for(b=0;b<d.localData.length;b++){for(c=!1,e=0;e<g.length;e++)f=G(d.localData[b],g[e])||"",c=c||f.toString().toLowerCase().indexOf(a.toString().toLowerCase())>=0;c&&(h[h.length]=d.localData[b])}d.searching=!1,fa(h,a)}function ca(a,b,c){if(!c)return!1;for(var e in b)if(b[e].toLowerCase()===c.toLowerCase())return d.selectResult(a),!0;return!1}function da(){aa(),qa&&g.cancel(qa),d.searching=!0,qa=g(function(){ea(d.searchStr)},d.pause)}function ea(a){!a||a.length<d.minLengthForApiCall||(d.localData?d.$apply(function(){ba(a)}):d.remoteApiHandler?$(a):Z(a))}function fa(a,b){var c,e,f,g,h,i;if(a&&a.length>0)for(d.results=[],c=0;c<a.length;c++)d.titleField&&""!==d.titleField&&(g=h=F(a[c])),e="",d.descriptionField&&(e=i=G(a[c],d.descriptionField)),f="",d.imageField&&(f=G(a[c],d.imageField)),d.matchClass&&(h=H(g,b),i=H(e,b)),d.results[d.results.length]={title:h,description:i,image:f,originalObject:a[c]};else d.results=[];d.autoMatch&&1===d.results.length&&ca(d.results[0],{title:g,desc:e||""},d.searchStr)?d.showDropdown=!1:0!==d.results.length||la?d.showDropdown=!0:d.showDropdown=!1}function ga(){d.localData?fa(d.localData,""):d.remoteApiHandler?$(""):Z("")}var ha,ia,ja,ka,la,ma,na,oa=h.find("input"),pa=r,qa=null,ra=w,sa=null,ta=null,ua=null,va=!1,wa=null;d.results=[],h.on("mousedown",function(a){a.target.id?(wa=a.target.id,wa===d.id+"_dropdown"&&document.body.addEventListener("click",A)):wa=a.target.className}),d.currentIndex=d.focusFirst?0:-1,d.searching=!1,ja=d.$watch("initialValue",function(a,b){a&&(ja(),z(a,!0))}),d.$watch("fieldRequired",function(a,b){a!==b&&(a?I(sa&&d.currentIndex!==-1?!0:!1):j[d.inputName].$setValidity(ra,!0))}),ma=d.templateDropdownUrl?a.element('<div angucomplete-alt-dropdown template-url="'+d.templateDropdownUrl+'"></div>'):a.element("<div angucomplete-alt-dropdown></div>"),d.$on("angucomplete-alt:clearInput",function(a,b){b&&b!==d.id||(d.searchStr=null,C(),I(!1),_())}),d.$on("angucomplete-alt:changeInput",function(a,b,c){b&&b===d.id&&z(c)}),d.onFocusHandler=function(){d.focusIn&&d.focusIn(),"0"!==d.minLengthForApiCall||d.searchStr&&0!==d.searchStr.length&&d.searchStr.toLowerCase()!==d.defaultLocation.toLowerCase()||(d.currentIndex=d.focusFirst?0:d.currentIndex,d.showDropdown=!0,ga()),d.suggestOnFocus&&d.searchStr&&d.searchStr.length>=pa&&da()},d.hideResults=function(a){wa&&(wa===d.id+"_dropdown"||wa.indexOf("angucomplete")>=0||wa.indexOf("_ClearId")>=0)?wa=null:(ha=g(function(){_(),d.$apply(function(){d.searchStr&&d.searchStr.length>0&&(oa.val(d.searchStr),oa.trigger("change"),d.focusOut&&d.focusOut())})},u),Y(),d.overrideSuggestions&&d.searchStr&&d.searchStr.length>0&&d.currentIndex===-1&&K())},d.resetHideResults=function(){ha&&g.cancel(ha)},d.hoverRow=function(a){d.currentIndex=a},d.selectResultWithClick=function(a){var b=F(a.originalObject)===d.clearListCustomLabel;b?d.$emit("angucomplete_on_clear_list"):(Q(),oa.trigger("change"),d.selectResult(a),d.$emit("angucomplete_click_select"))},d.selectResult=function(a){d.matchClass&&(a.title=F(a.originalObject),a.description=G(a.originalObject,d.descriptionField)),d.clearSelected?d.searchStr=null:d.searchStr=a.title,C(a),_()},d.inputChangeHandler=function(a){return void 0===a||a.length<d.minLengthForApiCall?(Y(),_()):(a.length<d.minLengthForApiCall||0===a.length&&"0"===d.minLengthForApiCall)&&(d.searching=!1,ga()),d.inputChanged&&(a=d.inputChanged(a)),a},d.fieldRequiredClass&&""!==d.fieldRequiredClass&&(ra=d.fieldRequiredClass),d.minlength&&""!==d.minlength&&(pa=parseInt(d.minlength,10)),d.pause||(d.pause=t),d.clearSelected||(d.clearSelected=!1),d.overrideSuggestions||(d.overrideSuggestions=!1),d.fieldRequired&&j&&I(d.initialValue?!0:!1),d.inputType=i.type?i.type:"text",d.textSearching=i.textSearching?i.textSearching:x,d.textNoResults=i.textNoResults?i.textNoResults:y,ka="false"!==d.textSearching,la="false"!==d.textNoResults,d.maxlength=i.maxlength?i.maxlength:s,oa.on("keydown",U),oa.on("keyup",J),ia=D("remoteUrlResponseFormatter"),d.$on("$destroy",function(){I(!0),na.remove(),ma.remove()}),na=c(ma)(d),d.bindDropdownSelector?g(function(){a.element(d.bindDropdownSelector).append(na)}):oa.after(na),ua=na,g(function(){var a=getComputedStyle(na[0]);va=a.maxHeight&&"auto"===a.overflowY})}var k=40,l=39,m=38,n=37,o=27,p=13,q=9,r=0,s=524288,t=500,u=200,v=120,w="autocomplete-required",x="Searching...",y="No results found",z="/angucomplete-alt/index.html";return h.put(z,'<div class="angucomplete-holder" ng-class="{\'angucomplete-dropdown-visible\': showDropdown}">  <input id="{{id}}_value" name="{{inputName}}" ng-class="{\'angucomplete-input-not-empty\': notEmpty}" ng-model="searchStr" ng-disabled="disableInput" type="{{inputType}}" placeholder="{{placeholder}}" maxlength="{{maxlength}}" ng-focus="onFocusHandler()" class="{{inputClass}}" ng-focus="resetHideResults()" ng-blur="hideResults($event)" autocapitalize="off" autocorrect="off" autocomplete="off" ng-change="inputChangeHandler(searchStr)"/></div>'),{restrict:"EA",require:"^?form",scope:{selectedObject:"=",disableInput:"=",initialValue:"=",localData:"=",remoteUrlRequestFormatter:"=",remoteUrlRequestWithCredentials:"@",remoteUrlResponseFormatter:"=",remoteUrlErrorCallback:"=",remoteApiHandler:"=",id:"@",type:"@",placeholder:"@",remoteUrl:"@",remoteUrlDataField:"@",titleField:"@",descriptionField:"@",imageField:"@",inputClass:"@",pause:"@",searchFields:"@",minlength:"@",matchClass:"@",clearSelected:"@",overrideSuggestions:"@",fieldRequired:"=",fieldRequiredClass:"@",inputChanged:"=",autoMatch:"@",focusOut:"&",focusIn:"&",inputName:"@",focusFirst:"@",bindDropdownSelector:"@",templateDropdownUrl:"@",suggestOnFocus:"@",clearListCustomLabel:"@",minLengthForMatchClass:"@",minLengthForApiCall:"@",defaultLocation:"@"},templateUrl:function(a,b){return b.templateUrl||z},compile:function(a,b){var c=i.startSymbol(),d=i.endSymbol();if("{{"!==c||"}}"!==d){var e=a.html().replace(/\{\{/g,c).replace(/\}\}/g,d);a.html(e)}return j}}}]).directive("angucompleteAltDropdown",["$templateCache",function(a){var b="/angucomplete-alt/dropdown.html";return a.put(b,'  <div id="{{id}}_dropdown" class="angucomplete-dropdown" ng-show="showDropdown">    <div class="angucomplete-searching" ng-show="searching" ng-bind="textSearching"></div>    <div class="angucomplete-searching" ng-show="!searching && (!results || results.length == 0)" ng-bind="textNoResults"></div>    <div class="angucomplete-row" ng-repeat="result in results" ng-click="selectResultWithClick(result)" ng-mouseenter="hoverRow($index)" ng-class="{\'angucomplete-selected-row\': $index == currentIndex}">      <div ng-if="imageField" class="angucomplete-image-holder">        <img ng-if="result.image && result.image != \'\'" ng-src="{{result.image}}" class="angucomplete-image"/>        <div ng-if="!result.image && result.image != \'\'" class="angucomplete-image-default"></div>      </div>      <div class="angucomplete-title" ng-if="matchClass" ng-bind-html="result.title"></div>      <div class="angucomplete-title" ng-if="!matchClass">{{ result.title }}</div>      <div ng-if="matchClass && result.description && result.description != \'\'" class="angucomplete-description" ng-bind-html="result.description"></div>      <div ng-if="!matchClass && result.description && result.description != \'\'" class="angucomplete-description">{{result.description}}</div>    </div>  </div>'),{restrict:"A",scope:!1,replace:!1,templateUrl:function(a,c){return c.templateUrl||b},link:function(a,b,c){a.templateUrl=c.templateDropdownUrl}}}])});